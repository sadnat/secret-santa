<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let groupRows = '';
if (groups.length > 0) {
  groupRows = groups.map(g => {
    const date = new Date(g.created_at).toLocaleDateString('fr-FR');
    const status = g.archived_at ? '<span class="status-archived">Archive</span>' : '<span class="status-active">Actif</span>';
    const deleteForm = `<form action="/organizer/groups/${g.id}/delete" method="POST" style="display:inline;" onsubmit="return confirm('Etes-vous sur de vouloir supprimer le groupe \\'${escapeHtml(g.name).replace(/'/g, "\\'")}\\' ? Cette action est irreversible et supprimera tous les participants et tirages associes.')"><input type="hidden" name="_csrf" value="${csrfToken}"><button type="submit" class="btn btn-small btn-danger">Supprimer</button></form>`;
    return `<tr>
      <td><strong><a href="/organizer/groups/${g.id}">${escapeHtml(g.name)}</a></strong></td>
      <td><code>${escapeHtml(g.code)}</code></td>
      <td>${date}</td>
      <td>${status}</td>
      <td>
        <a href="/organizer/groups/${g.id}" class="btn btn-small btn-primary">Gerer</a>
        ${deleteForm}
      </td>
    </tr>`;
  }).join('');
}

const body = `
<div class="admin-page">
  <h1>Mes Groupes</h1>

  <section class="create-group-section">
    <h2>Creer un nouveau groupe</h2>
    <form action="/organizer/groups/create" method="POST" class="inline-form" style="display: flex; gap: 10px; align-items: flex-end; margin-bottom: 30px;">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <div class="form-group" style="flex-grow: 1; margin-bottom: 0;">
        <label for="group_name" style="display: block; margin-bottom: 5px;">Nom du groupe</label>
        <input type="text" id="group_name" name="group_name" placeholder="Ex: Noel 2026" required minlength="2" style="width: 100%; box-sizing: border-box;">
      </div>
      <button type="submit" class="btn btn-primary" style="margin-bottom: 0;">Creer</button>
    </form>
  </section>

  <section class="groups-list-section">
    <h2>Vos groupes existants</h2>

    ${groups.length === 0 ? '<p class="empty-message">Vous n\'avez aucun groupe.</p>' : `
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Code Invitation</th>
            <th>Cree le</th>
            <th>Statut</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${groupRows}
        </tbody>
      </table>
    </div>
    `}
  </section>
</div>
` %>
<%- include('../layout', { title, organizer, body }) %>
