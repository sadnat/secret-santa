<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let participantRows = '';
if (participants.length > 0) {
  participantRows = participants.map(p => {
    const wishes = [p.wish1, p.wish2, p.wish3].filter(Boolean).map(w => escapeHtml(w)).join(', ');
    const date = new Date(p.created_at).toLocaleDateString('fr-FR');
    const deleteForm = drawExists
      ? '<span class="text-muted">-</span>'
      : `<form action="/organizer/groups/${group.id}/participants/${p.id}/delete" method="POST" style="display:inline;" onsubmit="return confirm('Supprimer ?')"><input type="hidden" name="_csrf" value="${csrfToken}"><button type="submit" class="btn btn-small btn-danger">Supprimer</button></form>`;
    return `<tr><td>${escapeHtml(p.first_name)} ${escapeHtml(p.last_name)}</td><td>${escapeHtml(p.email)}</td><td>${wishes || '-'}</td><td>${date}</td><td>${deleteForm}</td></tr>`;
  }).join('');
}

const body = `
<div class="admin-page">
  <div class="header-with-actions">
    <h1>Tableau de bord</h1>
    <a href="/organizer/dashboard" class="btn btn-small btn-secondary">&larr; Retour aux groupes</a>
  </div>
  <p class="group-info">Groupe : <strong>${escapeHtml(group.name)}</strong>
    ${group.budget ? ' &mdash; Budget : <strong>' + escapeHtml(group.budget) + '</strong>' : ''}
    ${group.event_date ? ' &mdash; Date : <strong>' + new Date(group.event_date + 'T00:00:00').toLocaleDateString('fr-FR') + '</strong>' : ''}
  </p>

  <div class="admin-stats">
    <div class="stat-card">
      <span class="stat-value">${participants.length}</span>
      <span class="stat-label">Participants</span>
    </div>
    <div class="stat-card ${drawExists ? 'stat-success' : ''}">
      <span class="stat-value">${drawExists ? 'Oui' : 'Non'}</span>
      <span class="stat-label">Tirage effectue</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${sentEmails} / ${participants.length}</span>
      <span class="stat-label">Emails envoyes</span>
    </div>
    <div class="stat-card ${smtpConfigured ? 'stat-success' : 'stat-warning'}">
      <span class="stat-value">${smtpConfigured ? 'Oui' : 'Non'}</span>
      <span class="stat-label">SMTP configure</span>
    </div>
  </div>

  <div class="admin-actions">
    <a href="/organizer/groups/${group.id}/settings" class="btn btn-secondary">Parametres / Lien invitation</a>
    <a href="/organizer/groups/${group.id}/exclusions" class="btn btn-secondary">Gerer les exclusions</a>
    <a href="/organizer/groups/${group.id}/draw" class="btn btn-primary">Tirage au sort</a>
  </div>

  ${!drawExists && !group.archived_at ? `
  <section class="add-participant-section">
    <h2>Ajouter un participant</h2>
    <form action="/organizer/groups/${group.id}/participants/add" method="POST" class="settings-form">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <div class="form-row" style="display: flex; gap: 10px; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 150px;">
          <label for="add_first_name">Prenom *</label>
          <input type="text" id="add_first_name" name="first_name" required minlength="2" placeholder="Prenom">
        </div>
        <div class="form-group" style="flex: 1; min-width: 150px;">
          <label for="add_last_name">Nom *</label>
          <input type="text" id="add_last_name" name="last_name" required minlength="2" placeholder="Nom">
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
          <label for="add_email">Email *</label>
          <input type="email" id="add_email" name="email" required placeholder="email@exemple.com">
        </div>
      </div>
      <details style="margin-bottom: 1rem;">
        <summary style="cursor: pointer; color: #666;">Souhaits (optionnel)</summary>
        <div class="form-row" style="display: flex; gap: 10px; flex-wrap: wrap; margin-top: 0.5rem;">
          <div class="form-group" style="flex: 1; min-width: 150px;">
            <input type="text" name="wish1" placeholder="Souhait 1">
          </div>
          <div class="form-group" style="flex: 1; min-width: 150px;">
            <input type="text" name="wish2" placeholder="Souhait 2">
          </div>
          <div class="form-group" style="flex: 1; min-width: 150px;">
            <input type="text" name="wish3" placeholder="Souhait 3">
          </div>
        </div>
      </details>
      <button type="submit" class="btn btn-primary">Ajouter</button>
    </form>
  </section>
  ` : ''}

  <section class="participants-section">
    <h2>Liste des participants (${participants.length})</h2>

    ${participants.length === 0 ? '<p class="empty-message">Aucun participant inscrit pour le moment. Partagez votre lien depuis les parametres ou ajoutez-en manuellement ci-dessus.</p>' : `
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Souhaits</th>
            <th>Inscrit le</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${participantRows}
        </tbody>
      </table>
    </div>
    `}
  </section>
</div>
` %>
<%- include('../layout', { title, organizer: locals.organizer, body }) %>
