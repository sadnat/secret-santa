<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

const appUrl = typeof locals.appUrl !== 'undefined' && locals.appUrl ? locals.appUrl : 'https://santa.twibox.fr';
const inviteLink = `${appUrl}/join/${group.code}`;
const isArchived = group.archived_at !== null;
const eventDateValue = group.event_date || '';
const budgetValue = group.budget || '';

const body = `
<div class="admin-page">
  <h1>Parametres du groupe</h1>

  ${isArchived ? '<div class="alert alert-warning">Ce groupe est archive. Les modifications sont desactivees.</div>' : ''}

  <section class="settings-section">
    <h2>Informations du groupe</h2>
    ${!isArchived ? `
    <form action="/organizer/groups/${group.id}/settings/update" method="POST" class="settings-form">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <div class="form-group">
        <label for="name">Nom du groupe</label>
        <input type="text" id="name" name="name" required minlength="2"
               value="${escapeHtml(group.name)}" placeholder="Ex: Noel 2026">
      </div>
      <div class="form-row" style="display: flex; gap: 15px; flex-wrap: wrap;">
        <div class="form-group" style="flex: 1; min-width: 200px;">
          <label for="budget">Budget (optionnel)</label>
          <input type="text" id="budget" name="budget"
                 value="${escapeHtml(budgetValue)}" placeholder="Ex: 20-30 euros">
          <small>Indiquez une fourchette de prix pour les cadeaux.</small>
        </div>
        <div class="form-group" style="flex: 1; min-width: 200px;">
          <label for="event_date">Date de l&#39;evenement (optionnel)</label>
          <input type="date" id="event_date" name="event_date"
                 value="${eventDateValue}">
          <small>La date de l&#39;echange de cadeaux.</small>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Enregistrer</button>
    </form>
    ` : `
    <div class="info-card">
      <p><strong>Nom du groupe :</strong> ${escapeHtml(group.name)}</p>
      <p><strong>Budget :</strong> ${budgetValue ? escapeHtml(budgetValue) : '<em>Non defini</em>'}</p>
      <p><strong>Date :</strong> ${eventDateValue ? new Date(eventDateValue + 'T00:00:00').toLocaleDateString('fr-FR') : '<em>Non definie</em>'}</p>
      <p><strong>Code Invitation :</strong> ${escapeHtml(group.code)}</p>
      <p><strong>Statut :</strong> <span class="status-archived">Archive</span></p>
    </div>
    `}
  </section>

  <section class="settings-section">
    <h2>Lien d&#39;invitation</h2>
    <p>Partagez ce lien ou ce code avec les participants pour les inviter a rejoindre votre groupe.</p>

    <div class="invite-box">
      <div class="invite-code">
        <strong>Code :</strong>
        <span class="code-value">${group.code}</span>
      </div>
      <div class="invite-link">
        <strong>Lien :</strong>
        <div class="link-copy-container">
          <input type="text" id="invite-link-input" value="${inviteLink}" readonly class="link-input" onclick="this.select()">
          <button type="button" class="btn btn-primary btn-copy" onclick="copyInviteLink()">Copier</button>
        </div>
      </div>
    </div>

    ${!isArchived ? `
    <form action="/organizer/groups/${group.id}/settings/regenerate-code" method="POST" class="regenerate-form"
          onsubmit="return confirm('Regenerer le code ? Le code actuel ne fonctionnera plus.')">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <button type="submit" class="btn btn-secondary">Regenerer le code</button>
    </form>
    ` : ''}
  </section>

  <section class="settings-section">
    <h2>Gestion du groupe</h2>
    ${isArchived ? `
    <p>Ce groupe est actuellement archive. Les participants ne peuvent plus s&#39;inscrire et aucune modification n&#39;est possible.</p>
    <form action="/organizer/groups/${group.id}/settings/unarchive" method="POST" class="archive-form">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <button type="submit" class="btn btn-primary">Desarchiver le groupe</button>
    </form>
    ` : `
    <p>Archiver le groupe bloque toutes les modifications et empeche les nouvelles inscriptions. Vous pourrez desarchiver plus tard si necessaire.</p>
    <form action="/organizer/groups/${group.id}/settings/archive" method="POST" class="archive-form"
          onsubmit="return confirm('Archiver ce groupe ? Les modifications seront bloquees.')">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <button type="submit" class="btn btn-warning">Archiver le groupe</button>
    </form>
    `}
  </section>

  <div class="back-link">
    <a href="/organizer/groups/${group.id}" class="btn btn-secondary">Retour au tableau de bord</a>
  </div>
</div>

<script>
function copyInviteLink() {
  const input = document.getElementById('invite-link-input');
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value).then(function() {
    const btn = document.querySelector('.btn-copy');
    const originalText = btn.textContent;
    btn.textContent = 'Copie !';
    btn.classList.add('btn-success');
    setTimeout(function() {
      btn.textContent = originalText;
      btn.classList.remove('btn-success');
    }, 2000);
  });
}
</script>
` %>
<%- include('../layout', { title, organizer: locals.organizer, body }) %>
