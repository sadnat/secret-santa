<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

const inviteLink = `https://santa.twibox.fr/join/${group.code}`;
const isArchived = group.archived_at !== null;

const body = `
<div class="admin-page">
  <h1>Parametres du groupe</h1>

  ${message ? '<div class="alert alert-success">' + escapeHtml(message) + '</div>' : ''}
  ${error ? '<div class="alert alert-error">' + escapeHtml(error) + '</div>' : ''}

  ${isArchived ? '<div class="alert alert-warning">Ce groupe est archive. Les modifications sont desactivees.</div>' : ''}

  <section class="settings-section">
    <h2>Informations du groupe</h2>
    <div class="info-card">
      <p><strong>Nom du groupe :</strong> ${escapeHtml(group.name)}</p>
      <p><strong>Code Invitation :</strong> ${escapeHtml(group.code)}</p>
      <p><strong>Statut :</strong> ${isArchived ? '<span class="status-archived">Archive</span>' : '<span class="status-active">Actif</span>'}</p>
    </div>
  </section>

  <section class="settings-section">
    <h2>Lien d&#39;invitation</h2>
    <p>Partagez ce lien ou ce code avec les participants pour les inviter a rejoindre votre groupe.</p>

    <div class="invite-box">
      <div class="invite-code">
        <strong>Code :</strong>
        <span class="code-value">${group.code}</span>
      </div>
      <div class="invite-link">
        <strong>Lien :</strong>
        <div class="link-copy-container">
          <input type="text" id="invite-link-input" value="${inviteLink}" readonly class="link-input" onclick="this.select()">
          <button type="button" class="btn btn-primary btn-copy" onclick="copyInviteLink()">Copier</button>
        </div>
      </div>
    </div>

    ${!isArchived ? `
    <form action="/organizer/groups/${group.id}/settings/regenerate-code" method="POST" class="regenerate-form"
          onsubmit="return confirm('Regenerer le code ? Le code actuel ne fonctionnera plus.')">
      <button type="submit" class="btn btn-secondary">Regenerer le code</button>
    </form>
    ` : ''}
  </section>

  <section class="settings-section">
    <h2>Gestion du groupe</h2>
    ${isArchived ? `
    <p>Ce groupe est actuellement archive. Les participants ne peuvent plus s&#39;inscrire et aucune modification n&#39;est possible.</p>
    <form action="/organizer/groups/${group.id}/settings/unarchive" method="POST" class="archive-form">
      <button type="submit" class="btn btn-primary">Desarchiver le groupe</button>
    </form>
    ` : `
    <p>Archiver le groupe bloque toutes les modifications et empeche les nouvelles inscriptions. Vous pourrez desarchiver plus tard si necessaire.</p>
    <form action="/organizer/groups/${group.id}/settings/archive" method="POST" class="archive-form"
          onsubmit="return confirm('Archiver ce groupe ? Les modifications seront bloquees.')">
      <button type="submit" class="btn btn-warning">Archiver le groupe</button>
    </form>
    `}
  </section>

  <div class="back-link">
    <a href="/organizer/groups/${group.id}" class="btn btn-secondary">Retour au tableau de bord</a>
  </div>
</div>

<script>
function copyInviteLink() {
  const input = document.getElementById('invite-link-input');
  input.select();
  input.setSelectionRange(0, 99999);
  navigator.clipboard.writeText(input.value).then(function() {
    const btn = document.querySelector('.btn-copy');
    const originalText = btn.textContent;
    btn.textContent = 'Copie !';
    btn.classList.add('btn-success');
    setTimeout(function() {
      btn.textContent = originalText;
      btn.classList.remove('btn-success');
    }, 2000);
  });
}
</script>
` %>
<%- include('../layout', { title, organizer: locals.organizer, body }) %>
