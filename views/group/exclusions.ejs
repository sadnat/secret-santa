<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let participantOptions = participants.map(p =>
  `<option value="${p.id}">${escapeHtml(p.first_name)} ${escapeHtml(p.last_name)}</option>`
).join('');

let exclusionRows = exclusions.map(e => {
  const deleteForm = drawExists
    ? '<span class="text-muted">-</span>'
    : `<form action="/organizer/groups/${group.id}/exclusions/${e.id}/delete" method="POST" style="display:inline;"><input type="hidden" name="_csrf" value="${csrfToken}"><button type="submit" class="btn btn-small btn-danger">Supprimer</button></form>`;
  return `<tr><td><strong>${escapeHtml(e.giver_name)}</strong></td><td class="arrow-cell">ne peut pas offrir a</td><td><strong>${escapeHtml(e.receiver_name)}</strong></td><td>${deleteForm}</td></tr>`;
}).join('');

const body = `
<div class="admin-page">
  <h1>Regles d&#39;exclusion</h1>
  <p>Definissez qui ne peut PAS offrir a qui (ex: conjoints, collegues du meme bureau, etc.)</p>

  <div class="alert alert-info">
    <strong>Conseil :</strong> Pour interdire completement les cadeaux entre deux personnes, vous devez creer deux regles. Par exemple, pour que A et B ne puissent pas s'offrir de cadeaux, creez une regle "A ne peut pas offrir a B" ET une regle "B ne peut pas offrir a A".
  </div>

  ${message ? '<div class="alert alert-success">' + escapeHtml(message) + '</div>' : ''}
  ${error ? '<div class="alert alert-error">' + escapeHtml(error) + '</div>' : ''}

  ${drawExists ? '<div class="alert alert-warning">Le tirage a deja ete effectue. Les exclusions ne peuvent plus etre modifiees.</div>' : ''}

  ${!drawExists && participants.length >= 2 ? `
  <section class="add-exclusion-section">
    <h2>Ajouter une regle</h2>
    <form action="/organizer/groups/${group.id}/exclusions/add" method="POST" class="exclusion-form">
      <input type="hidden" name="_csrf" value="${csrfToken}">
      <div class="form-row">
        <div class="form-group">
          <label for="giver_id">Cette personne</label>
          <select id="giver_id" name="giver_id" required>
            <option value="">Selectionner...</option>
            ${participantOptions}
          </select>
        </div>
        <div class="form-group arrow-group">
          <span class="arrow">ne peut pas offrir a</span>
        </div>
        <div class="form-group">
          <label for="receiver_id">Cette personne</label>
          <select id="receiver_id" name="receiver_id" required>
            <option value="">Selectionner...</option>
            ${participantOptions}
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Ajouter la regle</button>
    </form>
  </section>
  ` : ''}

  ${participants.length < 2 ? '<div class="alert alert-info">Il faut au moins 2 participants pour definir des exclusions.</div>' : ''}

  <section class="exclusions-list-section">
    <h2>Regles actuelles</h2>

    ${exclusions.length === 0 ? "<p class=\"empty-message\">Aucune regle definie.</p>" : `
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Ne peut pas offrir</th>
            <th></th>
            <th>A</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${exclusionRows}
        </tbody>
      </table>
    </div>
    `}
  </section>

  <div class="back-link">
    <a href="/organizer/groups/${group.id}" class="btn btn-secondary">Retour au tableau de bord</a>
  </div>
</div>
` %>
<%- include('../layout', { title, organizer: locals.organizer, body }) %>
