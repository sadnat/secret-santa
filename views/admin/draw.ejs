<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let assignmentRows = '';
if (assignments && assignments.length > 0) {
  assignmentRows = assignments.map(a => {
    const emailStatus = a.email_sent
      ? '<span class="badge badge-success">âœ“ EnvoyÃ©</span>'
      : '<span class="badge badge-pending">En attente</span>';
    return `<tr><td>${escapeHtml(a.giver_name)}</td><td>${escapeHtml(a.giver_email)}</td><td>${emailStatus}</td></tr>`;
  }).join('');
}

const body = `
<div class="admin-page">
  <h1>ğŸ² Tirage au sort</h1>

  ${message ? '<div class="alert alert-success">' + escapeHtml(message) + '</div>' : ''}
  ${error ? '<div class="alert alert-error">' + escapeHtml(error) + '</div>' : ''}

  <div class="draw-status">
    <div class="status-card">
      <h3>Participants</h3>
      <p class="status-value">${participantCount}</p>
    </div>
    <div class="status-card">
      <h3>Statut du tirage</h3>
      <p class="status-value ${drawExists ? 'status-done' : 'status-pending'}">${drawExists ? 'EffectuÃ© âœ“' : 'En attente'}</p>
    </div>
    <div class="status-card">
      <h3>Emails</h3>
      <p class="status-value">${sentEmails} / ${participantCount} envoyÃ©s</p>
    </div>
  </div>

  ${!drawExists ? `
  <section class="draw-action-section">
    <h2>Lancer le tirage</h2>
    ${!canDraw.possible ? '<div class="alert alert-warning">âš ï¸ ' + escapeHtml(canDraw.reason) + '</div>' : ''}
    ${participantCount < 2 ? '<div class="alert alert-warning">âš ï¸ Il faut au moins 2 participants pour effectuer un tirage.</div>' : `
    <p>Une fois le tirage effectuÃ© :</p>
    <ul>
      <li>Chaque participant sera assignÃ© Ã  une autre personne</li>
      <li>Les assignations sont chiffrÃ©es et vous ne pourrez pas les voir</li>
      <li>Vous pourrez envoyer les emails aux participants</li>
    </ul>
    <form action="/admin/draw/perform" method="POST" class="draw-form" onsubmit="return confirm('Lancer le tirage ? Cette action ne peut pas Ãªtre facilement annulÃ©e.')">
      <button type="submit" class="btn btn-primary btn-large" ${participantCount < 2 || !canDraw.possible ? 'disabled' : ''}>ğŸ² Lancer le tirage</button>
    </form>
    `}
  </section>
  ` : `
  <section class="draw-results-section">
    <h2>RÃ©sultats du tirage</h2>
    <p class="security-notice">ğŸ”’ Les assignations sont chiffrÃ©es. Vous pouvez voir qui participe mais pas qui offre Ã  qui.</p>
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Participant</th>
            <th>Email</th>
            <th>Email envoyÃ©</th>
          </tr>
        </thead>
        <tbody>
          ${assignmentRows}
        </tbody>
      </table>
    </div>
  </section>

  <section class="email-section">
    <h2>ğŸ“§ Envoi des emails</h2>
    ${!smtpConfigured ? '<div class="alert alert-warning">âš ï¸ SMTP non configurÃ©. Configurez les variables SMTP_HOST, SMTP_USER et SMTP_PASS.</div>' : '<p>Envoyez les emails Ã  tous les participants pour leur rÃ©vÃ©ler leur Secret Santa.</p>'}
    <div class="email-actions">
      ${pendingEmails > 0 ? `
      <form action="/admin/draw/send-emails" method="POST" style="display:inline;">
        <button type="submit" class="btn btn-primary" ${!smtpConfigured ? 'disabled' : ''}>ğŸ“§ Envoyer ${pendingEmails} email(s)</button>
      </form>
      ` : '<p class="text-success">âœ“ Tous les emails ont Ã©tÃ© envoyÃ©s !</p>'}
    </div>
  </section>

  <section class="reset-section">
    <h2>âš ï¸ RÃ©initialiser</h2>
    <p class="text-warning">Attention : cette action supprimera le tirage actuel et tous les emails envoyÃ©s seront perdus.</p>
    <form action="/admin/draw/reset" method="POST" onsubmit="return confirm('Confirmer la suppression du tirage ?')">
      <button type="submit" class="btn btn-danger">RÃ©initialiser le tirage</button>
    </form>
  </section>
  `}

  <div class="back-link">
    <a href="/admin" class="btn btn-secondary">â† Retour au tableau de bord</a>
  </div>
</div>
` %>
<%- include('../layout', { title, isAdmin, body }) %>
