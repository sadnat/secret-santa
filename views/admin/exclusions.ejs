<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let participantOptions = participants.map(p =>
  `<option value="${p.id}">${escapeHtml(p.first_name)} ${escapeHtml(p.last_name)}</option>`
).join('');

let exclusionRows = exclusions.map(e => {
  const deleteForm = drawExists
    ? '<span class="text-muted">-</span>'
    : `<form action="/admin/exclusions/${e.id}/delete" method="POST" style="display:inline;"><button type="submit" class="btn btn-small btn-danger">Supprimer</button></form>`;
  return `<tr><td><strong>${escapeHtml(e.giver_name)}</strong></td><td class="arrow-cell">‚Üí</td><td><strong>${escapeHtml(e.receiver_name)}</strong></td><td>${deleteForm}</td></tr>`;
}).join('');

const body = `
<div class="admin-page">
  <h1>üö´ R√®gles d'exclusion</h1>
  <p>D√©finissez qui ne peut PAS offrir √† qui (ex: conjoints, coll√®gues du m√™me bureau, etc.)</p>

  ${message ? '<div class="alert alert-success">' + escapeHtml(message) + '</div>' : ''}
  ${error ? '<div class="alert alert-error">' + escapeHtml(error) + '</div>' : ''}

  ${drawExists ? '<div class="alert alert-warning">‚ö†Ô∏è Le tirage a d√©j√† √©t√© effectu√©. Les exclusions ne peuvent plus √™tre modifi√©es.</div>' : ''}

  ${!drawExists && participants.length >= 2 ? `
  <section class="add-exclusion-section">
    <h2>Ajouter une r√®gle</h2>
    <form action="/admin/exclusions/add" method="POST" class="exclusion-form">
      <div class="form-row">
        <div class="form-group">
          <label for="giver_id">Cette personne</label>
          <select id="giver_id" name="giver_id" required>
            <option value="">S√©lectionner...</option>
            ${participantOptions}
          </select>
        </div>
        <div class="form-group arrow-group">
          <span class="arrow">‚Üí ne peut pas offrir √† ‚Üí</span>
        </div>
        <div class="form-group">
          <label for="receiver_id">Cette personne</label>
          <select id="receiver_id" name="receiver_id" required>
            <option value="">S√©lectionner...</option>
            ${participantOptions}
          </select>
        </div>
      </div>
      <button type="submit" class="btn btn-primary">Ajouter la r√®gle</button>
    </form>
  </section>
  ` : ''}

  ${participants.length < 2 ? '<div class="alert alert-info">Il faut au moins 2 participants pour d√©finir des exclusions.</div>' : ''}

  <section class="exclusions-list-section">
    <h2>R√®gles actuelles</h2>

    ${exclusions.length === 0 ? "<p class=\"empty-message\">Aucune r√®gle d'exclusion d√©finie.</p>" : `
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Ne peut pas offrir</th>
            <th></th>
            <th>√Ä</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${exclusionRows}
        </tbody>
      </table>
    </div>
    `}
  </section>

  <div class="back-link">
    <a href="/admin" class="btn btn-secondary">‚Üê Retour au tableau de bord</a>
  </div>
</div>
` %>
<%- include('../layout', { title, isAdmin, body }) %>
