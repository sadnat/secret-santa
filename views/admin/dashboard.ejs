<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let participantRows = '';
if (participants.length > 0) {
  participantRows = participants.map(p => {
    const wishes = [p.wish1, p.wish2, p.wish3].filter(Boolean).map(w => escapeHtml(w)).join(', ');
    const date = new Date(p.created_at).toLocaleDateString('fr-FR');
    const deleteForm = drawExists
      ? '<span class="text-muted">-</span>'
      : `<form action="/admin/participants/${p.id}/delete" method="POST" style="display:inline;" onsubmit="return confirm('Supprimer ?')"><button type="submit" class="btn btn-small btn-danger">Supprimer</button></form>`;
    return `<tr><td>${escapeHtml(p.first_name)} ${escapeHtml(p.last_name)}</td><td>${escapeHtml(p.email)}</td><td>${wishes || '-'}</td><td>${date}</td><td>${deleteForm}</td></tr>`;
  }).join('');
}

const body = `
<div class="admin-page">
  <h1>ðŸ“Š Tableau de bord</h1>

  ${message ? '<div class="alert alert-success">' + escapeHtml(message) + '</div>' : ''}
  ${error ? '<div class="alert alert-error">' + escapeHtml(error) + '</div>' : ''}

  <div class="admin-stats">
    <div class="stat-card">
      <span class="stat-value">${participants.length}</span>
      <span class="stat-label">Participants</span>
    </div>
    <div class="stat-card ${drawExists ? 'stat-success' : ''}">
      <span class="stat-value">${drawExists ? 'âœ“' : 'âœ—'}</span>
      <span class="stat-label">Tirage effectuÃ©</span>
    </div>
    <div class="stat-card">
      <span class="stat-value">${sentEmails} / ${participants.length}</span>
      <span class="stat-label">Emails envoyÃ©s</span>
    </div>
    <div class="stat-card ${smtpConfigured ? 'stat-success' : 'stat-warning'}">
      <span class="stat-value">${smtpConfigured ? 'âœ“' : 'âœ—'}</span>
      <span class="stat-label">SMTP configurÃ©</span>
    </div>
  </div>

  <div class="admin-actions">
    <a href="/admin/exclusions" class="btn btn-secondary">GÃ©rer les exclusions</a>
    <a href="/admin/draw" class="btn btn-primary">Tirage au sort</a>
  </div>

  <section class="participants-section">
    <h2>Liste des participants</h2>

    ${participants.length === 0 ? '<p class="empty-message">Aucun participant inscrit pour le moment.</p>' : `
    <div class="table-wrapper">
      <table class="data-table">
        <thead>
          <tr>
            <th>Nom</th>
            <th>Email</th>
            <th>Souhaits</th>
            <th>Inscrit le</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody>
          ${participantRows}
        </tbody>
      </table>
    </div>
    `}
  </section>
</div>
` %>
<%- include('../layout', { title, isAdmin, body }) %>
