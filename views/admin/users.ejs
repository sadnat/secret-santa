<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';

let userRows = '';
if (users.length === 0) {
  userRows = `<tr><td colspan="8" style="text-align: center; color: #666; padding: 2rem;">Aucun utilisateur trouve.</td></tr>`;
} else {
  userRows = users.map(user => {
    const date = new Date(user.created_at).toLocaleDateString('fr-FR');
    return `<tr>
      <td>${user.id}</td>
      <td>${escapeHtml(user.first_name)} ${escapeHtml(user.last_name)}</td>
      <td>${escapeHtml(user.email)}</td>
      <td>${user.group_count}</td>
      <td>${user.is_verified ? '<span class="badge badge-success">Oui</span>' : '<span class="badge badge-pending">Non</span>'}</td>
      <td>${user.is_admin ? '<span class="badge badge-success">Oui</span>' : 'Non'}</td>
      <td>${date}</td>
      <td class="actions">
        <form action="/admin/users/${user.id}/toggle-admin" method="POST" style="display:inline;">
          <input type="hidden" name="_csrf" value="${csrfToken}">
          <button type="submit" class="btn btn-small ${user.is_admin ? 'btn-secondary' : 'btn-primary'}">
            ${user.is_admin ? 'Retirer admin' : 'Rendre admin'}
          </button>
        </form>
        <form action="/admin/users/${user.id}/delete" method="POST" style="display:inline;" 
              onsubmit="return confirm('Etes-vous sur de vouloir supprimer cet utilisateur ? Cette action est irreversible.');">
          <input type="hidden" name="_csrf" value="${csrfToken}">
          <button type="submit" class="btn btn-small btn-danger">Supprimer</button>
        </form>
      </td>
    </tr>`;
  }).join('');
}

const searchQuery = typeof search !== 'undefined' ? escapeHtml(search) : '';
const currentPage = typeof page !== 'undefined' ? page : 1;
const pages = typeof totalPages !== 'undefined' ? totalPages : 1;
const total = typeof totalCount !== 'undefined' ? totalCount : 0;

let paginationHtml = '';
if (pages > 1) {
  let links = '';
  const qParam = searchQuery ? `&q=${encodeURIComponent(search)}` : '';
  
  if (currentPage > 1) {
    links += `<a href="/admin/users?page=${currentPage - 1}${qParam}" class="pagination-link">&laquo; Precedent</a>`;
  }
  
  for (let i = 1; i <= pages; i++) {
    if (i === 1 || i === pages || (i >= currentPage - 2 && i <= currentPage + 2)) {
      links += `<a href="/admin/users?page=${i}${qParam}" class="pagination-link ${i === currentPage ? 'active' : ''}">${i}</a>`;
    } else if (i === currentPage - 3 || i === currentPage + 3) {
      links += `<span class="pagination-ellipsis">...</span>`;
    }
  }
  
  if (currentPage < pages) {
    links += `<a href="/admin/users?page=${currentPage + 1}${qParam}" class="pagination-link">Suivant &raquo;</a>`;
  }
  
  paginationHtml = `<div class="pagination">${links}</div>`;
}

const body = `
<div class="container admin-page">
  <h1>Gestion des utilisateurs</h1>
  
  <p><a href="/admin">&larr; Retour au tableau de bord</a></p>

  <div class="admin-toolbar">
    <form action="/admin/users" method="GET" class="search-form">
      <input type="text" name="q" value="${searchQuery}" placeholder="Rechercher par nom ou email..." class="search-input">
      <button type="submit" class="btn btn-primary btn-small">Rechercher</button>
      ${searchQuery ? '<a href="/admin/users" class="btn btn-secondary btn-small">Effacer</a>' : ''}
    </form>
    <div class="result-count">${total} utilisateur${total !== 1 ? 's' : ''} ${searchQuery ? 'trouve(s)' : 'au total'}</div>
  </div>

  <div class="table-wrapper">
    <table class="admin-table data-table">
      <thead>
        <tr>
          <th>ID</th>
          <th>Nom</th>
          <th>Email</th>
          <th>Groupes</th>
          <th>Verifie</th>
          <th>Admin</th>
          <th>Inscrit le</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        ${userRows}
      </tbody>
    </table>
  </div>

  ${paginationHtml}
</div>
`;
%>
<%- include('../layout', { title: 'Gestion des utilisateurs', organizer, body }) %>
