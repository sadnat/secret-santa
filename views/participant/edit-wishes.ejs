<%
const escapeHtml = (str) => str ? String(str).replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;').replace(/'/g, '&#39;') : '';
const recipient = typeof myRecipient !== 'undefined' ? myRecipient : null;

const body = `
<div class="form-page">
  <h1>Mon Secret Santa</h1>
  <p class="group-context">Bonjour <strong>${escapeHtml(participant.first_name)}</strong> ! Vous participez au groupe <strong>${escapeHtml(participant.group_name)}</strong>.</p>

  ${error ? '<div class="alert alert-error">' + escapeHtml(error) + '</div>' : ''}

  ${recipient ? `
  <div class="my-assignment">
    <h2>Votre tirage au sort</h2>
    <p>Vous devez offrir un cadeau a :</p>
    <div class="recipient-reveal">
      ${escapeHtml(recipient.first_name)} ${escapeHtml(recipient.last_name)}
    </div>
    ${(() => {
      const wishes = [recipient.wish1, recipient.wish2, recipient.wish3].filter(Boolean);
      if (wishes.length > 0) {
        return '<h3>Ses idees de cadeaux :</h3><ul class="wishes-list">' +
          wishes.map(w => '<li>' + escapeHtml(w) + '</li>').join('') +
          '</ul>';
      }
      return '<p class="text-muted"><em>Cette personne n\\\'a pas indique de souhaits particuliers.</em></p>';
    })()}
  </div>
  ` : `
  <div class="alert alert-info">Le tirage au sort n'a pas encore ete effectue. Vous serez notifie par email lorsque ce sera fait.</div>
  `}

  <form action="/participant/${token}" method="POST" class="register-form">
    <input type="hidden" name="_csrf" value="${csrfToken}">

    <div class="form-section">
      <h2>Vos souhaits de cadeaux</h2>
      <p class="section-description">Modifiez vos idees de cadeaux pour aider votre Secret Santa !</p>

      <div class="form-group">
        <label for="wish1">Souhait 1</label>
        <input type="text" id="wish1" name="wish1"
               value="${escapeHtml(participant.wish1 || '')}"
               placeholder="Ex: Un livre de cuisine">
      </div>
      <div class="form-group">
        <label for="wish2">Souhait 2</label>
        <input type="text" id="wish2" name="wish2"
               value="${escapeHtml(participant.wish2 || '')}"
               placeholder="Ex: Des chaussettes rigolotes">
      </div>
      <div class="form-group">
        <label for="wish3">Souhait 3</label>
        <input type="text" id="wish3" name="wish3"
               value="${escapeHtml(participant.wish3 || '')}"
               placeholder="Ex: Du chocolat">
      </div>
    </div>

    <button type="submit" class="btn btn-primary btn-large">Enregistrer mes souhaits</button>
  </form>

  <p class="back-link" style="margin-top: 1.5rem;"><a href="/">Retour a l'accueil</a></p>
</div>

<style>
  .my-assignment {
    background: linear-gradient(135deg, #fff8dc, #ffe4e1);
    padding: 1.5rem;
    border-radius: 8px;
    margin-bottom: 2rem;
    text-align: center;
  }
  .my-assignment h2 {
    color: var(--primary-color, #c41e3a);
    margin-bottom: 0.5rem;
  }
  .my-assignment h3 {
    color: var(--text-color, #333);
    margin-top: 1rem;
    text-align: left;
  }
  .recipient-reveal {
    font-size: 1.8rem;
    font-weight: bold;
    color: var(--primary-color, #c41e3a);
    background: white;
    padding: 1rem;
    border-radius: 8px;
    margin: 1rem 0;
    border: 2px dashed var(--secondary-color, #228b22);
  }
  .wishes-list {
    list-style: none;
    padding: 0;
    text-align: left;
  }
  .wishes-list li {
    padding: 0.5rem 0.75rem;
    background: rgba(255,255,255,0.7);
    margin: 0.25rem 0;
    border-radius: 4px;
    border-left: 3px solid var(--secondary-color, #228b22);
  }
</style>
` %>
<%- include('../layout', { title, organizer: null, body }) %>
